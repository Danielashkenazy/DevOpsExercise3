name: CI - GeoJSON Local Test

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test-app:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgis/postgis:15-3.3
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_pass
          POSTGRES_DB: geojson_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test_user -d geojson_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          sudo apt-get update && sudo apt-get install -y postgresql-client
          pip install -r Docker/requirements.txt "moto[server]" boto3 psycopg2-binary geojson flask werkzeug

      - name: Start local S3 mock
        run: |
          export AWS_ACCESS_KEY_ID=fake
          export AWS_SECRET_ACCESS_KEY=fake
          export AWS_DEFAULT_REGION=us-east-1
          nohup moto_server -H 0.0.0.0 -p 5000 &
          sleep 5
          aws --endpoint-url http://localhost:5000 s3 mb s3://test-bucket
          aws --endpoint-url http://localhost:5000 s3 cp Terraform/test5.geojson s3://test-bucket/test_data.geojson

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..10}; do
            pg_isready -h localhost -p 5432 -U test_user -d geojson_test && break
            echo "â³ Waiting for Postgres..."
            sleep 5
          done
          PGPASSWORD=test_pass psql -h localhost -U test_user -d geojson_test -c "CREATE EXTENSION IF NOT EXISTS postgis;"

      - name: Set environment variables
        run: |
          echo "S3_BUCKET=test-bucket" >> $GITHUB_ENV
          echo "S3_KEY=test_data.geojson" >> $GITHUB_ENV
          echo "AWS_ACCESS_KEY_ID=fake" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=fake" >> $GITHUB_ENV
          echo "AWS_DEFAULT_REGION=us-east-1" >> $GITHUB_ENV
          echo "AWS_ENDPOINT_URL=http://localhost:5000" >> $GITHUB_ENV
          echo "DB_HOST=localhost" >> $GITHUB_ENV
          echo "DB_NAME=geojson_test" >> $GITHUB_ENV
          echo "DB_USER=test_user" >> $GITHUB_ENV
          echo "DB_PASS=test_pass" >> $GITHUB_ENV
          echo "TABLE_NAME=geo_features" >> $GITHUB_ENV
          echo "GEOM_SRID=4326" >> $GITHUB_ENV

      - name: Run GeoJSON app against local mock
        working-directory: Docker
        env:
          AWS_ENDPOINT_URL: http://localhost:5000
        run: |
          echo "ðŸ§ª Running GeoJSON processor..."
          python app.py

      - name: Verify database contents
        run: |
          PGPASSWORD=test_pass psql -h localhost -U test_user -d geojson_test -c "\dt"
          echo "âœ… Checking inserted features:"
          PGPASSWORD=test_pass psql -h localhost -U test_user -d geojson_test -c "SELECT id, name, properties FROM geo_features;"
          echo "âœ… Count verification:"
          PGPASSWORD=test_pass psql -h localhost -U test_user -d geojson_test -c "SELECT COUNT(*) FROM geo_features;"
